<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>适配Android5.0之后的通知</title>
	
	<meta name="author" content="JackLee">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/shinyjacklee">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a class="navbar-brand" href="/">
				<img src="http://www.gravatar.com/avatar/?s=35" class="img-circle" />
				JackLee
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="https://avatars3.githubusercontent.com/u/9441660?v=3&s=150" />
	</a>
	<h3 class="title">
        <a href="/">JackLee</a>
    </h3>
</header>


<div id="bio" class="text-center">
	One  Developer who love design:)
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/shinyjacklee">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="/">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>适配Android5.0之后的通知 </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   May 
	   24th,
	   
	   2016
	 </span>
	  <div class="article_body">
	  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>是时候记录关于通知Notification的事情了，我们厂App的通知Notification在5.0+上面icon显示白块，下来展开也是白块，这是个问题。
</code></pre></div></div>

<h3 id="背景及解决的过程记录">背景及解决的过程记录</h3>
<p>查了一圈下来，原因是在lollipop上开始，Android的Notification作了较大的变动，更多的Android 系统的特性和用户体验（更多的代码要写）。</p>

<blockquote>
  <p>在 Android 5.0 中，通知在结构、外观和功能方面获得了重要的更新：</p>
</blockquote>

<ul>
  <li>通知在外观上发生了更改，与新的材料设计主题保持一致。</li>
  <li>通知现在可以在设备锁定屏幕上使用，而敏感信息仍然可以隐藏于背后。</li>
  <li>设备在使用时收到的高优先级通知现在采用名为浮动通知的新格式。</li>
  <li>云同步通知：在一台 Android 设备上清除通知，则在其他设备上也会将其清除
<a href="https://developer.android.com/design/patterns/notifications.html">From Design Pure Android</a></li>
</ul>

<p>在文档中找到了原因（解释）</p>
<blockquote>
  <p>使用不同的图标</p>
</blockquote>

<ul>
  <li>建议用法</li>
</ul>

<p><strong>查看 Android 应用已经提供的通知图标并为您的应用创建外观明显不同的通知图标。
对小图标使用正确的通知图标样式，对操作图标使用相应的材料灯操作栏图标。
图标外观要简洁清晰，避免使用过于精细、难以辨认的图标</strong></p>

<ul>
  <li>
    <s>禁忌用法</s>
  </li>
</ul>

<s>对小图标和操作图标设置任何附加的阿尔法通道属性（变暗或变淡）；这些图标会有抗锯齿边缘，但是由于 Android 使用这些图标作为蒙板（即仅使用阿尔法通道），因此通常应以完全不透明的方式绘制图像。
利用色彩将您的应用与其他应用区分开来。通知图标应该是纯白透明背景图像。</s>

<p><strong>就是说，smallIcon对应的那个icon应该是只具备黑白的，不要使用什么阴影之类的。
而LargeIcon是可以是app应用的彩色样式的图片的。</strong>
这就是为何我们的通知出来的都是一个白块的解释。至于 代码层面的解释，如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private RemoteViews applyStandardTemplate(int resId, boolean hasProgress) {
//...
if (mLargeIcon != null) {
     contentView.setImageViewBitmap(R.id.icon, mLargeIcon);
     processLargeLegacyIcon(mLargeIcon, contentView);
     contentView.setImageViewResource(R.id.right_icon, mSmallIcon);
     contentView.setViewVisibility(R.id.right_icon, View.VISIBLE);
     processSmallRightIcon(mSmallIcon, contentView);
 } else { // small icon at left
     contentView.setImageViewResource(R.id.icon, mSmallIcon);
     contentView.setViewVisibility(R.id.icon, View.VISIBLE);
     processSmallIconAsLarge(mSmallIcon, contentView);
}
//... } /**
     * Recolor small icons when used in the R.id.right_icon slot.
     */
    private void processSmallRightIcon(int smallIconDrawableId,
            RemoteViews contentView) {
        if (!isLegacy() || mColorUtil.isGrayscaleIcon(mContext, smallIconDrawableId)) {
            contentView.setDrawableParameters(R.id.right_icon, false, -1,
                    0xFFFFFFFF,
                    PorterDuff.Mode.SRC_ATOP, -1);

            contentView.setInt(R.id.right_icon,
                    "setBackgroundResource",
                    R.drawable.notification_icon_legacy_bg);

            contentView.setDrawableParameters(
                    R.id.right_icon,
                    true,
                    -1,
                    resolveColor(),
                    PorterDuff.Mode.SRC_ATOP,
                    -1);
        }
    } 
    ⚠️代码分析来自下面《Android5.0通知变化浅析》 OK，原因我们基本上搞清楚了，简单说，就是Lollipop以后，为了风格统一，状态栏那边做了处理，都只能用alpha通道描述的小icon作Notification的smallIcon。不符合这个要求的图片在变动的代码处理之后就变白的了。
</code></pre></div></div>

<h3 id="方案">方案</h3>
<p>那么解决方案呢？哈哈哈哈，问Google啊。</p>

<p>最后我们是在SO社区找到的<a href="http://stackoverflow.com/questions/28387602/notification-bar-icon-turns-white-in-android-5-lollipop">答案</a>,方案有俩，简单来说：</p>

<ol>
  <li>治标不治本～
省事的做法把targetVersion设置为20吧，这样的效果是：你可以保持在5.0+的设备上，smallIcon是彩色的，但是缺陷是，无法使用Lollipop上Notification新的feature or API.</li>
  <li>治本！
顾名思义，修改你的smallIcon符合Android 5.0+的<a href="http://developer.android.com/design/style/iconography.html">设计规范</a>,即，只有alpha通道的图。</li>
  <li>嗯?
更加的方案？治标而且快？嗯，试试这个<a href="http://romannurik.github.io/AndroidAssetStudio/icons-notification.html">助手</a>，很好很强大，省的和设计费口水，讲了半天还不知道怎么做，然后自己试了半天还是白板，然后又不好意思继续骚扰人家。
使用很简单，类似TinyPNG那个压缩图片的，直接把你的smallIcon 拖拽进去，然后输NAME，如果符合规范的你就会看到生成好的icon，不然就是白板。整理好了之后，可以直接download下所有drawable-xxx的图片，效率极大的提升！</li>
</ol>

<blockquote>
  <p>Thx GitHub ,Thx Stackoverflow.etc</p>
</blockquote>

<p>其实，我们的项目还有一个插曲，就是Jpush极光推送，用过的就知道了，嗯，他们新的版本支持了，把SDK里面的一套全部到Jpush更新一下吧。</p>

<hr />

<h4 id="额外的极光的章节">额外的极光的章节</h4>

<blockquote>
  <p>说明 1：若没有res/drawable-xxxx/jpush_notification_icon这个资源默认使用应用图标作为通知icon，在5.0以上系统将应用图标作为statusbar icon可能显示不正常，用户可定义没有阴影和渐变色的icon替换这个文件，文件名不要变。
<a href="http://docs.jiguang.cn/guideline/android_guide/#sdk">参考SDK文档的关于这个的说明</a></p>
</blockquote>

<hr />
<p>嗯，Finally，用bing搜索搜到的值得看参考了的结果如下：</p>

<ul>
  <li><a href="http://blog.csdn.net/guolin_blog/article/details/50945228"> Android通知栏微技巧，那些你所没关注过的小细节</a></li>
  <li><a href="http://www.cnblogs.com/avenwu/p/4180193.html">Android5.0通知变化浅析</a></li>
</ul>


	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#Android-ref">
					Android <span>(14)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#Notification-ref">
					Notification <span>(1)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#Lollipop-ref">
					Lollipop <span>(1)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=适配Android5.0之后的通知"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="https://avatars3.githubusercontent.com/u/9441660?v=3&s=50" class="img-rounded author-image" />
        <h4 class="section-title author-name">JackLee</h4>
        <p class="author-bio">One  Developer who love design:)</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/android/2016/05/10/%E5%85%B3%E4%BA%8E%E5%BC%95%E5%AF%BC%E9%A1%B5%E9%9D%A2.html" title="关于引导页面">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/devtool/2016/06/21/Jenkins%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E5%B7%A5%E5%85%B7%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95.html" title="Jenkins持续集成工具使用记录">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2015 ~ 2018 JackLee with Jekyll. Theme: <a href="https://github.com/dbtek/dbyll">dbyll</a> by dbtek.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



